<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Plugin Example</title>

    <script type="text/javascript" src="js/i2b2-loader.js" ></script>
    <link rel="stylesheet" type="text/css" href="css/example-main.css">

</head>
<body>
    <h1>This is plugin: edu.harvard.catalyst.example</h1>
        <input type="button" onclick="sendInitMsg()" value="Send Init Notice" />
        <input type="button" onclick="sendTestMsg()" value="Send Message" />
        <p>
            <input name="stateString" id="stateString" onkeyup="saveState()"/>
            <input type="button" onclick="window.location.reload()" value="Reload Plugin">
        </p>

    </form>

    <div id="ExamplePlugin-psmaindiv">
        drop a patient set here
        <div class="psmaindiv-content"></div>
    </div>

    <div id="ExamplePlugin-maindiv">
        drop any item here
        <div class="maindiv-content"></div>
    </div>

    <script>
        function saveState() {
            i2b2.model.stateString = document.getElementById("stateString").value;
            i2b2.state.save();
        }

        function sendInitMsg() {
            console.log("sending Init message...");
            window.parent.postMessage({"msgType":"INIT"}, "/");
        }

        function sendTestMsg() {
            console.log("sending test message...");
            let ajaxData = {
                ont_synonym_records: "N",
                ont_hidden_records: "N"
            };
            i2b2.ajax.ONT.GetCategories(ajaxData).then((data)=> {
                console.log("Got response base from ONT.GetCategories()");
                console.log(data);
            })
        }

        window.addEventListener("I2B2_READY", ()=> {
            // the i2b2 framework is loaded and ready (including population of i2b2.model namespace)
            if (i2b2.model.stateString === undefined) i2b2.model.stateString = "";
            document.getElementById("stateString").value = i2b2.model.stateString;
        });

        i2b2.ExamplePlugin = {};
        i2b2.ExamplePlugin.prsDropped = function(sdxData) {
            console.dir("example plugin received patient drop " + sdxData);
            let newNode = document.createElement('div');
            newNode.innerHTML = JSON.stringify(sdxData);
            let mainDiv = document.getElementsByClassName("psmaindiv-content")[0];
            mainDiv.innerHTML= JSON.stringify(sdxData);
        };

        i2b2.ExamplePlugin.itemDropped = function(sdxData) {
            console.dir("example plugin received item drop " + sdxData);
            let mainDiv = document.getElementsByClassName("maindiv-content")[0];
            mainDiv.innerHTML= JSON.stringify(sdxData);
        };

        window.addEventListener("I2B2_SDX_READY", (event) => {
            console.dir("sd ready before: " + JSON.stringify(event.data));
            let op_trgt = {dropTarget:true};
            i2b2.sdx.AttachType("ExamplePlugin-psmaindiv", "PRS", op_trgt);

            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "CONCPT", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "PRS", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "ENS", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "PRC", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "QDEF", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "QGDEF", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "QI", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "QM", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "WRK", op_trgt);
            i2b2.sdx.AttachType("ExamplePlugin-maindiv", "XML", op_trgt);

            // drop event handlers used by this plugin
            i2b2.sdx.setHandlerCustom("ExamplePlugin-psmaindiv", "PRS", "DropHandler", i2b2.ExamplePlugin.prsDropped);

            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "CONCPT", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "PRS", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "ENS", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "PRC", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "QDEF", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "QGDEF", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "Qi", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "QM", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "WRK", "DropHandler", i2b2.ExamplePlugin.itemDropped);
            i2b2.sdx.setHandlerCustom("ExamplePlugin-maindiv", "XML", "DropHandler", i2b2.ExamplePlugin.itemDropped);
        });
    </script>
</body>
</html>